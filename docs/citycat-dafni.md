## CityCAT on DAFNI

CityCAT (City Catchment Analysis Tool) is a unique software tool for modelling, analysis and visualisation of surface water flooding. CityCAT enables rapid assessment of combined pluvial and fluvial flood risk and allows assessment of the effects of different flood alleviation measures. This DAFNI model generates input data for CityCAT, runs a simulation and then converts the output data. All input data is assumed to be projected in [OSGB 1936](https://epsg.io/27700). The domain is generated either using a boundary polygon or a combination of centroid location and size. A rainfall total can either be specified directly or extracted from FUTURE-DRAINAGE based on a return period, duration and time horizon. The storm profile is generated using the FEH summer profile. The effects of buildings, green areas and inflow boundary conditions can be included. Results are provided in a range of formats and a metadata JSON file is created which can be used to create DAFNI datasets.


## Parameters

| name                | title                       | description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
|:--------------------|:----------------------------|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| NAME                | Run name                    | Name for the run, used in the title field of the metadata file.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| RAINFALL_MODE       | Rainfall mode               | If `RAINFALL_MODE` is set to "return_period" then the rainfall depth corresponding to the `DURATION` and `RETURN_PERIOD` are extracted from the relevant CSV file in the `future-drainage` dataslot. If the `TIME_HORIZON` is anything other than "baseline", the rainfall depth is then uplifted by the percentage given in the CSV file. If `RAINFALL_MODE` is set to "total_depth" then the `TOTAL_DEPTH` parameter is used to define the amount of rainfall and the `RETURN_PERIOD` and `TIME_HORIZON` parameters are ignored. The rainfall depth value, either directly provided or extracted from FUTURE-DRAINAGE, is used to generate a storm profile in combination with the summer profile and `DURATION` parameter. |
| RETURN_PERIOD       | Return Period (years)       | The return period of the rainfall event. This parameter is only used if `RAINFALL_MODE` is set to "return_period". If this is provided, then data must be present in the `future-drainage` dataslot. This return period is used to extract a rainfall depth from the FUTURE-DRAINAGE dataset and select the percentage uplift if required.                                                                                                                                                                                                                                                                                                                                                                                    |
| TOTAL_DEPTH         | Total depth (mm)            | The total depth of rainfall during the event. This parameter is only used if `RAINFALL_MODE` is set to "total_depth".                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| DURATION            | Duration (hours)            | The duration of the rainfall event. This value is used in combination with the rainfall depth and summer profile to generate a storm profile. If `RAINFALL_MODE` is "return_period", this value is also used to extract a rainfall depth from FUTURE-DRAINAGE. Only specific values are available as there is a limited number of durations within FUTURE-DRAINAGE.                                                                                                                                                                                                                                                                                                                                                           |
| POST_EVENT_DURATION | Post-event Duration (hours) | The duration of the dry period following the rainfall event. After the rainfall event ends, CityCAT will continue to run for this period of time. This is to allow water to continue propogating and accumulating on the floodplain.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| SIZE                | Domain Size (km)            | The width and height of the domain to create, centered at the location specified by `X` and `Y`. This value is only used if no data is available in the `boundary` dataslot.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| OUTPUT_INTERVAL     | Output Interval (seconds)   | Time between depth and velocity outputs (s). Decreasing this value will lead to a higher number of output files.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| X                   | Domain Centroid X (OSGB)    | The X coordinate of the domain centroid in OSGB. This value is only used if no data is available in the `boundary` dataslot.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| Y                   | Domain Centroid Y (OSGB)    | The Y coordinate of the domain centroid in OSGB. This value is only used if no data is available in the `boundary` dataslot.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| OPEN_BOUNDARIES     | Open Boundaries             | If `OPEN_BOUNDARIES` is "True", water will be allowed to leave the domain at the edges. If it is "False", water will bounce back from the edges of the domain and cannot leave.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| PERMEABLE_AREAS     | Permeable areas             | If `PERMEABLE_AREAS` is set to "polygons", polygons from the `green_areas` dataslot are used to define areas which are permeable. Otherwise, all cells are treated as being "permeable" or "impermeable", depending on the selection.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| ROOF_STORAGE        | Roof storage                | Depth of water that can be stored on rooftops (m). This value is uniformly applied to all buildings.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| TIME_HORIZON        | Time horizon                | The time horizon to use when selecting rainfall uplifts, baseline indicates no uplift. This is used in combination with the `RETURN_PERIOD` and `DURATION` to select a rainfall depth from FUTURE-DRAINAGE.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| DISCHARGE           | Discharge (m3/s)            | Value of discharge boundary condition, if provided then the `flow_polygons` dataslot is required. Discharge is distributed uniformly over the `DURATION` and gets multiplied by the number of cell boundaries intersected by the polygons in the `flow_polygons` dataslot. Therefore, it is normally advisable to divide the total desired discharge by the number of overlapping cell boundaries.                                                                                                                                                                                                                                                                                                                            |

## Dataslots

| path                   | name                    | description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|:-----------------------|:------------------------|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| inputs/dem             | Digital Elevation Model | A DEM must be provided in ASCII raster format, within a single file or as multiple tiles. The default DEM dataset is OS Terrain 5, a corrected digital surface model of the UK with 5m resolution. The dataset was created using a combination of photogrammetry and topographic survey and is updated regularly. This data is licenced for research only.                                                                                                                                                                                                                 |
| inputs/boundary        | Boundary                | A polygon can be provided to define the domain in GeoPackage or Shapefile format. If this is provided, the X, Y and SIZE parameters will be ignored.                                                                                                                                                                                                                                                                                                                                                                                                                       |
| inputs/future-drainage | Future Drainage         | Rainfall depths for a range of return periods, durations and time periods are provided by (FUTURE-DRAINAGE)[https://artefacts.ceda.ac.uk/badc_datadocs/future-drainage/FUTURE_DRAINAGE_Guidance_for_applying_rainfall_uplifts.pdf]. The estimates are based on 2.2 km hourly precipitation data from UKCP18 for RCP 8.5. Baseline rainfall depths are provided describing the period 1981-2000 in the ReturnLevel.<year> field. Percentage uplifts are available for two future horizons, 2050 and 2070. The values are provided for points on a 5km grid covering the UK. |
| inputs/buildings       | Buildings               | Buildings can be provided as polygons in GeoPackage or Shapefile format. Cells which fall within buildings are removed from the domain. By default, OS MasterMap is used to represent buildings. MasterMap is the most detailed and up-to-date view of Britain’s landscape. This data is licenced for research only. Optionally, future buildings generated by UDM can be provided and combined with the buildings from OS MasterMap. Cells within building polygons are removed from the domain.                                                                        |
| inputs/green_areas     | Green areas             | Green areas can be provided as polygons in GeoPackage or Shapefile format. Infiltration is allowed at cells within green areas polygons. By default, OS MasterMap is used to represent green spaces.                                                                                                                                                                                                                                                                                                                                                                       |
| inputs/flow_polygons   | Flow Polygons           | Optionally, discharge can be provided as an input parameter and used as a boundary condition. If discharge is provided, then a file containing a polygon that overlaps with domain cell boundaries is required. Discharge is routed onto the domain at these overlapping cell boundaries. The discharge is distributed uniformly over the specified duration and gets multiplied by the number of cells boundaries intersected.                                                                                                                                            |

## Outputs

| name                      | description                                                                                                                                                                                                                                                                                                                        |
|:--------------------------|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| outputs/run/**/*          | The CityCAT model outputs four GeoTIFF files describing maximum depth, maximum depth with gaps interpolated, maximum velocity and maximum velocity-depth product. The maximum depth is also plotted in a PNG file (Figure 1). The depths and velocities from all timesteps are stored in a netCDF file and archived to a ZIP file. |
| outputs/run/metadata.json | NID metadata for outputs. This file can be used for creating datasets on DAFNI. All active parameters are included in this file.                                                                                                                                                                                                   |